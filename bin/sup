#!/usr/bin/env ruby
require "highline"
HighLine.colorize_strings

def run(host, cmd, exit_on_failure: true)
  ssh_cmd = ["ssh", config, with_user(host), cmd].compact.join(" ")
  puts ssh_cmd.yellow
  system(ssh_cmd).tap do |success|
    exit(1) if exit_on_failure && !success
  end
end

def with_user(host)
  return host if host.include?("@")

  "root@#{host}"
end

def config
  "-F .ssh/config" if File.file?(".ssh/config")
end

completed = []

[*ARGV, nil].each_cons(2) do |host, next_host|
  break if host.nil?

  run host, "sudo apt-get -y autoremove"
  run host, "sudo apt-get -y autoclean"
  run host, "sudo DEBIAN_FRONTEND=noninteractive apt-get -q -q -y update"
  run host,
    "sudo DEBIAN_FRONTEND=noninteractive apt-get -q -q " \
    '-o DPkg::options::="--force-confdef" ' \
    '-o DPkg::options::="--force-confold" dist-upgrade'

  run host, "sudo checkrestart -v"

  completed << host
  completed.each { |h| puts "âœ” #{h}".green }

  puts "Next up: #{next_host}".red if next_host
  break unless HighLine.new.agree("Reboot #{host}#{' and proceed' if next_host} (y/n)? ".blue)

  run host, "sudo systemctl reboot", exit_on_failure: false
end
